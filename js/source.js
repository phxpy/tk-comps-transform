const posthtml = require('posthtml');
const minifier = require('posthtml-minifier');

const postcss = require("postcss");
const autoprefixer = require("autoprefixer");
const csso = require('csso');
const scopify = require('postcss-scopify');

const uglifyJS = require("./uglify");

const sources = Array.from(document.querySelectorAll(".source"));
const sourceCss = document.getElementById("txa-css");
const resultTxa = document.querySelector(".result");
const resetBtn = document.querySelector(".reset-btn");

const browserslist = ["defaults", "not dead", "last 10 versions"]
let scopeId = null

document.querySelector(".browserslist").textContent = `CSS: ${browserslist.join(", ")}`;

let comp = {}

resetBtn.addEventListener("click", () => {
    sources.forEach(source => {
        source.value = "";
    })
    resultTxa.value = "";
    comp = {}
})

sources.forEach(source => {
    source.addEventListener("input", e => {
        parseCode(source)
    })

    source.addEventListener("paste", e => {
        e.preventDefault();

        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        source.value = pastedText;

        parseCode(source)
    })
})

function parseCode(source) {
    if (source.id === "txa-html") {

        // HTML minifier

        posthtml()
            .use(minifier({
                collapseWhitespace: true,
                removeComments: true,
                includeAutoGeneratedTags: false,
                keepClosingSlash: true
            }))
            .process(source.value)
            .then(function (result) {
                scopeId = getCompId(result.html);
                comp["html"] = result.html
                resultTxa.value = JSON.stringify(comp, null, 4);
                parseCode(sourceCss)

                if (scopeId) {
                    document.getElementById("txa-css").disabled = false
                } else {
                    document.getElementById("txa-css").disabled = true
                }
            })
            .catch(function (error) {
                if (comp.hasOwnProperty("html")) {
                    comp["html"] = ""
                }
                resultTxa.value = JSON.stringify(comp, null, 4);
                scopeId = null
                document.getElementById("txa-css").disabled = true
                console.error("Bullshit! Not valid HTML! ðŸ’©");
            });

    } else if (source.id === "txa-css" && scopeId) {

        // CSS minifier and autoprefixer

        postcss([
            autoprefixer({ overrideBrowserslist: browserslist }),
            scopify(`#${scopeId}`)
        ]).process(source.value, { from: undefined }).then(result => {
            comp["css"] = csso.minify(result.css, { restructure: false }).css
            resultTxa.value = JSON.stringify(comp, null, 4);
        })
        .catch(error => {
            console.error("Bullshit! Not valid CSS! ðŸ’©");
        })

    } else if (source.id === "txa-js") {

        // JS minifier

        const result = uglifyJS.minify(source.value);
        if (!result.error) {
            comp["js"] = result.code
            resultTxa.value = JSON.stringify(comp, null, 4);
        } else {
            console.error("Bullshit! Not valid JS! ðŸ’©");
        }
    }
}

resultTxa.addEventListener("click", () => {
    navigator.clipboard.writeText(resultTxa.value);

    const span = document.createElement("span");
    span.classList.add("copied-msg");
    span.textContent = "Copied to clipboard";

    resultTxa.parentElement.appendChild(span);

    setTimeout(() => {
        resultTxa.parentElement.removeChild(span);
    }, 2000)
})

function getCompId(htmlString) {
    const div = document.createElement('div');
    div.innerHTML = htmlString.trim();

    if (div.firstChild.id) {
        return div.firstChild.id;
    } else {
        console.error("Bullshit! WHERE IS TOP LEVEL ID?! ðŸ’©");
    }
}
